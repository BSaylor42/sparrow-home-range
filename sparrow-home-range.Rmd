---
title: "Sparrow Home Range"
author: "Brianna Saylor"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#packages<-c("adehabitatHR","data.table","ggfortify","grid","move","OpenStreetMap","pbapply","plotly","tidyverse","viridis", "dplyr", "ggspatial", "raster", "sf", "terra", "terrainr", "maps")
pacman::p_load("adehabitatHR", "ctmm", "pbapply", "raster", "sf", "sp", "terra", "terrainr", "tidyverse", "plotly")
#sapply(packages, library, character.only=T)
sparrow <- read.csv("locationsll.csv")
# package moveVis not available for this version of R, trying without first
# package rgdal not available for this version of R, trying without first
```

White-throated sparrows are a winter resident in Tennessee. They are identifiable by their white throat and yellow patch in front of the eye. Their song is an iconic whistle in the winter often described as "O Sweet Canada." In the winter, they can be found in woods, forest edges, and shrubby fields. They will visit your bird feeder. 


```{r convert to UTM, include=FALSE}
library(sf)
sparrow <- st_as_sf(sparrow, coords = c("location.long", "location.lat"), crs = 4326) |>
  st_transform(crs = 32616) # in library sf
coords <- st_coordinates(sparrow)
sparrow <- cbind(sparrow, 
                utm_easting = coords[, "X"],
                utm_northing = coords[, "Y"])

nugget <- sparrow %>% 
  filter(individual.local.identifier == "1E2D334C")
```

Using plotly to check for any outliers in the dataset. 
```{r plotly, echo=TRUE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
qaqc_plot <- ggplot() + geom_point(data=nugget, 
                                   aes(utm_easting,utm_northing,
                                       color=individual.local.identifier)) +
                        labs(x="Easting", y="Northing") +
                        guides(color=guide_legend("Identifier"))

ggplotly(qaqc_plot)
```

```{r terrainr imagery}
map_points <- data.frame(
  lat = runif(10000, min = 36.536184, max = 36.540977),
  lng = runif(10000, min = -87.362532, max = -87.357254))
map_points <- sf::st_as_sf(map_points, coords = c("lng", "lat"))
map_points <- sf::st_set_crs(map_points, 4326)
output_files <- get_tiles(map_points,
                          resolution = 1,
                          output_prefix = "tiff",
                          services = c("ortho", "elevation"))
tiff <- "tiff_USGSNAIPPlus_1_1.tif"
image_stack <- stack(tiff)

image_rgb <- as.data.frame(image_stack, xy = TRUE) %>% setNames(c("x", "y", "red", "green", "blue", "alpha"))
ggplot()+geom_spatial_rgb(data = image_rgb, aes(x=x, y=y, r=red, g=green, b=blue)) +
  labs(x="Longtiude", y="Latitude") + theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + coord_sf(xlim = c(-87.362532, -87.357254),  ylim = c(36.536184, 36.540977))
```


```{r getting map imagery, include=FALSE}
ortho <- "clarksville.tif"

image_stack <- raster::stack(ortho)

crop_extent <- raster::extent(min(nugget$utm_easting-200), 
                              max(nugget$utm_easting+200), 
                              min(nugget$utm_northing-200), 
                              max(nugget$utm_northing+200))


image_crop <- crop(image_stack, crop_extent)

emerald.hill <- as.data.frame(image_crop, xy = TRUE) %>% setNames(c("x", "y", "red", "green", "blue"))

ggplot()+geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue))+coord_sf()
```

```{r minimum convex polygon, echo=TRUE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
## Data for a single individual
nugget_df <- as.data.frame(nugget)
xy <- c(as.data.frame(nugget_df$utm_easting),as.data.frame(nugget_df$utm_northing))
xy <- as.data.frame(xy)

## projecting the data to UTM
data.proj <- SpatialPointsDataFrame(xy,nugget_df, proj4string = CRS("+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs"))
xy.sp <- SpatialPoints(data.proj@coords)

## MCP analysis
mcp.out <- mcp(xy.sp, percent=100, unout="ha")

## converting mcp to sf object for ggplot and points to df
mcp.sf <- st_as_sf(mcp.out)

mcp.points <- cbind((data.frame(xy)),nugget_df$individual.local.identifier)
colnames(mcp.points) <- c("x","y", "identifier")

# MCP plot
mcp.plot <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  theme(panel.grid = element_blank()) +
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data=mcp.sf, alpha = 0.3) +
  geom_point(data=mcp.points, aes(x=x, y=y), color = "orange2")  +
  labs(x="Easting (m)", y="Northing (m)", title=mcp.points$identifier) +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5)) 

mcp.plot + annotate("text", x = 467400, y = 4043640, label = paste(round(mcp.out@data$area,2),"ha"), 
                    fontface = "bold", size = 5, color = "white")
```

```{r kernel density, echo=TRUE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
x <- as.data.frame(nugget_df$utm_easting)
y <- as.data.frame(nugget_df$utm_northing)
xy <- c(x,y)

## projecting the data to UTM
data.proj <- SpatialPointsDataFrame(xy,nugget_df, proj4string = CRS("+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs"))
xy.sp <- SpatialPoints(data.proj@coords)

## KDE analysis at 95, 85, 75
kde<-kernelUD(xy.sp, h="href", kern="bivnorm", grid=100)
ver95 <- getverticeshr(kde, 95)
ver85 <- getverticeshr(kde, 85)
ver75 <- getverticeshr(kde, 75)

## converting to sf object and df
kde.points <- cbind((data.frame(data.proj@coords)),nugget_df$individual.local.identifier)
colnames(kde.points) <- c("x","y","identifier")
kde95.sf <- st_as_sf(ver95)
kde85.sf <- st_as_sf(ver85)
kde75.sf <- st_as_sf(ver75)

##making the plot
kde.plot <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
   geom_point(data=kde.points, aes(x=x, y=y), color = "lightgray") +
  geom_sf(data=kde95.sf, fill = "blue", alpha = 0.5) +
  geom_sf(data=kde85.sf, fill = "green", alpha = 0.4) +
  geom_sf(data=kde75.sf, fill = "yellow", alpha = 0.3)  +
  labs(x="Easting (m)", y="Northing (m)", title=kde.points$identifier) +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5)) 
  
kde.plot + annotate("text", label = paste("95% ",round(ver95$area,2),"ha"), 
                    fontface = "bold", size = 4, color = "white")
```

```{r continuous time movement modeling}
# remove sf attribrutes 
nugget_df$geometry <- NULL
class(nugget_df) <- setdiff(class(nugget_df), "sf")
attr(nugget_df, "sf_column") <- NULL
attr(nugget_df, "agr") <- NULL
nugget_df$x <- nugget_df$utm_easting
nugget_df$y <- nugget_df$utm_northing
# convert to POSIXct
nugget_df$timestamp <- as.POSIXct(nugget_df$timestamp, format="%Y-%m-%d %H:%M:%S", tz="UTC") 
# remove duplicate times, need minimum 1 min intervals 
nugget_df <- nugget_df[!duplicated(nugget_df$timestamp), ]
# sort time stamps to make sure they are not out of order 
nugget_df <- nugget_df[order(nugget_df$timestamp), ]
# convert  to telemetry data
utm16 <- CRS("+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs")
nugget.telem <- as.telemetry(nugget_df, 
                             coords = c("x", "y"),
                               projection = "+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs")

```

