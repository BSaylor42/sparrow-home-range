---
title: "Sparrow Home Range"
author: "Brianna Saylor"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load("adehabitatHR", "ctmm", "pbapply", "raster", "sf", "sp", "terra", "terrainr", "tidyverse", "plotly", "patchwork")
sparrow <- read.csv("locationsll.csv")
```

## Dataset 

White-throated sparrows are a common winter songbird throughout the southern United States. As the name suggests, they are easily recognizable by their white throats. Their song is an iconic whistle often described as "O Sweet Canada." They can be found in woods, forest edges, shrubby fields, and at bird feeders. White-throated sparrows have tan striped and white striped color morphs which differ in behavior. 

<center>
<iframe src="https://macaulaylibrary.org/asset/645319050/embed" height="370" width="640" frameborder="0" allowfullscreen></iframe>
</center>

```{r convert to UTM, include=FALSE}
library(sf) # convert coordinates to UTM
sparrow <- st_as_sf(sparrow, coords = c("location.long", "location.lat"), crs = 4326) |>
  st_transform(crs = 32616) # in library sf
coords <- st_coordinates(sparrow)
sparrow <- cbind(sparrow, 
                utm_easting = coords[, "X"],
                utm_northing = coords[, "Y"])
# filter to one individual
nugget <- sparrow %>% 
  filter(individual.local.identifier == "1E2D334C")
```

Emerald Hill is a popular daytime hangout for white-throated sparrows. Several individuals have been tagged with telemetry units to understand their movement patterns and habitat use. For this exercise, I will be looking at the home range of the individual 1E2D334C who I have nicknamed Nugget.

First, I will take a quick look at the spread of the data to check for any outliers. 
```{r plotly, echo=TRUE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
qaqc_plot <- ggplot() + geom_point(data=nugget, aes(utm_easting,utm_northing), color = "orange2") +
                        labs(x="Easting", y="Northing") +
                        guides(color=guide_legend("Identifier"))

ggplotly(qaqc_plot)
```

```{r getting map imagery, include=FALSE}
ortho <- "clarksville.tif"

image_stack <- raster::stack(ortho)

crop_extent <- raster::extent(min(nugget$utm_easting-200), 
                              max(nugget$utm_easting+200), 
                              min(nugget$utm_northing-200), 
                              max(nugget$utm_northing+200))


image_crop <- crop(image_stack, crop_extent)

emerald.hill <- as.data.frame(image_crop, xy = TRUE) %>% setNames(c("x", "y", "red", "green", "blue"))

ggplot()+geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue))+coord_sf()
```
## Minimum Convex Polygon

Next, I will look at the home range of Nugget. For this analysis I am using minimum convex polygon to determine the minimum bounding geometry of the space used by Nugget. 
```{r minimum convex polygon, echo=TRUE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, fig.align='center'}
## Data for a single individual
nugget_df <- as.data.frame(nugget)
xy <- c(as.data.frame(nugget_df$utm_easting),as.data.frame(nugget_df$utm_northing))
xy <- as.data.frame(xy)

## projecting the data to UTM
data.proj <- SpatialPointsDataFrame(xy,nugget_df, proj4string = CRS("+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs"))
xy.sp <- SpatialPoints(data.proj@coords)

## MCP analysis
mcp.out <- mcp(xy.sp, percent=100, unout="ha")

## converting mcp to sf object for ggplot and points to df
mcp.sf <- st_as_sf(mcp.out)
mcp.points <- cbind((data.frame(xy)),nugget_df$individual.local.identifier)
colnames(mcp.points) <- c("x","y", "identifier")

# MCP plot
mcp.plot <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  theme(panel.grid = element_blank()) +
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data=mcp.sf, alpha = 0.3) +
  geom_point(data=mcp.points, aes(x=x, y=y), color = "orange2")  +
  labs(x="Easting (m)", y="Northing (m)", title=mcp.points$identifier) +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5), panel.grid = element_blank()) 

mcp.plot + annotate("text", x = 467400, y = 4043640, label = paste(round(mcp.out@data$area,2),"ha"), 
                    fontface = "bold", size = 5, color = "white")
```
It appears that Nugget uses a small portion of emerald hill about 10 ha in size mostly in wooded areas. Some of Nugget's range extends into the mowed lawn of Emerald Hill and the residential neighborhood next door. 

## Kernel-Density Estimation 

Which areas does Nugget use more? Let's look at Nugget's frequency of use with kernel-density estimation. I used 95% KDE (blue), 75% KDE (green), and 50% KDE (yellow). 
```{r kernel density, echo=TRUE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, fig.align='center'}
x <- as.data.frame(nugget_df$utm_easting)
y <- as.data.frame(nugget_df$utm_northing)
xy <- c(x,y)

## projecting the data to UTM
data.proj <- SpatialPointsDataFrame(xy,nugget_df, proj4string = CRS("+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs"))
xy.sp <- SpatialPoints(data.proj@coords)

## KDE analysis at 95, 85, 75
kde<-kernelUD(xy.sp, h="href", kern="bivnorm", grid=100)
ver95 <- getverticeshr(kde, 95)
ver85 <- getverticeshr(kde, 85)
ver75 <- getverticeshr(kde, 75)
ver50 <- getverticeshr(kde, 50)

## converting to sf object and df
kde.points <- cbind((data.frame(data.proj@coords)),nugget_df$individual.local.identifier)
colnames(kde.points) <- c("x","y","identifier")
kde95.sf <- st_as_sf(ver95)
kde85.sf <- st_as_sf(ver85)
kde75.sf <- st_as_sf(ver75)
kde50.sf <- st_as_sf(ver50)

##making the plot
kde.plot <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
   geom_point(data=kde.points, aes(x=x, y=y), color = "lightgray") +
  geom_sf(data=kde95.sf, fill = "blue", alpha = 0.4) +
  geom_sf(data=kde75.sf, fill = "green", alpha = 0.3) +
  geom_sf(data=kde50.sf, fill = "yellow", alpha = 0.2)  +
  labs(x="Easting (m)", y="Northing (m)", title=kde.points$identifier) +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 4)
  
kde.plot <- kde.plot + annotate("text", x = 467500, y = 4043640, label = paste("95% ",round(ver95$area,2),"ha"), 
                    fontface = "bold", size = 5, color = "white") 
 
kde.only.plot <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data=kde95.sf, fill = "blue", alpha = 0.4) +
  geom_sf(data=kde75.sf, fill = "green", alpha = 0.3) +
  geom_sf(data=kde50.sf, fill = "yellow", alpha = 0.2)  +
  labs(x="Easting (m)", y="Northing (m)", title=kde.points$identifier) +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 4)

kde.only.plot <- kde.only.plot + annotate("text", x = 467500, y = 4043640, label = paste("95%",round(ver95$area,2),"ha"),
                    fontface = "bold", size = 5, color = "white") 

kde.plot + kde.only.plot 
```
Using a 95% KDE, Nuggets range shrinks by half from 9.85 ha to 4.36 ha. 

<br> 

## MCP vs KDE

Now let's compare the minimum convex polygon to the kernel-density estimation to get a feel of where Nugget likes to hang out at Emerald Hill. 
```{r compare mcp to kde, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE, warning=FALSE}
mcp.kde.plot <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data=mcp.sf, alpha = 0.3) +
  geom_sf(data=kde95.sf, fill = "blue", alpha = 0.4) +
  geom_sf(data=kde75.sf, fill = "green", alpha = 0.3) +
  geom_sf(data=kde50.sf, fill = "yellow", alpha = 0.2)  +
  labs(x="Easting (m)", y="Northing (m)", title=kde.points$identifier) +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5), panel.grid = element_blank())

mcp.kde.plot <- mcp.kde.plot + 
  annotate("text", x = 467450, y = 4044100, label = paste("MCP",round(mcp.out@data$area,2),"ha"),
                    fontface = "bold", size = 4, color = "black") +
  annotate("text", x = 467450, y = 4044075, label = paste("95%",round(ver95$area,2),"ha"),
                    fontface = "bold", size = 4, color = "black") + 
  annotate("text", x = 467450, y = 4044050, label = paste("75%",round(ver75$area,2),"ha"),
                    fontface = "bold", size = 4, color = "black")  + 
  annotate("text", x = 467450, y = 4044025, label = paste("50%",round(ver50$area,2),"ha"),
                    fontface = "bold", size = 4, color = "black")

mcp.kde.plot
```
As seen from the map, Nugget prefers to spend time in the woods in the eastern portion of Emerald Hill. It is interesting to note that Nugget spends 50% of their time on an area less than 1 ha. Going forward, it would be interesting to see how the ranges of other sparrows on Emerald Hill overlap with Nugget. 

## Continuous-Time Movement Modeling

Now I will look at how the home range estimation changes when I account for the time between data points. 

```{r comments, include=FALSE}
# for the next section I had to end up reading in the original dataset again because after converting the points to UTM I had too many errors I could not fix. converting the UTM points to as.telemetry for some reason it could not identify the correct UTM zone. 
```


```{r wAKDE, echo=TRUE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, fig.align='center'}
# read in original dataset and filter to individual
sparrow2 <- read.csv("locationsll.csv")
nugget2 <- sparrow2 %>% 
  filter(individual.local.identifier == "1E2D334C")

# convert to telemetry data
nugget.telem <- as.telemetry(nugget2, 
                             coords = c("x", "y"),
                               projection = "+proj=utm +zone=16 +datum=WGS84 +units=m +no_defs")

# calculate fit object
nugget.guess <- ctmm.guess(nugget.telem, interactive=FALSE)

# compute akde and get summary information, note this will take time to run code
nugget.ouf <- ctmm.fit(nugget.telem, nugget.guess)
wAKDE.nugget <- akde(nugget.telem, nugget.ouf, weights=TRUE)
```
The graph shows the weighted autocorrelated kernel density estimate (wAKDE) which estimates the animal's space use while accounting for location error and temporal autocorrelation. Nugget's wAKDE is very flat indicating mostly regular fixes on the GPS. The sudden rise at the right of the graph indicates a few long gaps occurred where the GPS lost signal. This is probably due to Nugget leaving Emerald Hill in the evening to go sleep in another location. 

```{r utilization distribution map, echo=TRUE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, fig.align='center'}
# for home range estimate CI
summary(wAKDE.nugget)
# clean simple version
wAKDE1 <- plot(wAKDE.nugget)
```
From this graph, we can see that the confidence interval for the 95% range is close together. This is likely due to the high number of data points we have for Nugget. 

```{r wADKE conversion, echo=TRUE, warning=FALSE}
# convert to SPDF to convert to sf object for plotting in ggplot
ud.sp <- SpatialPolygonsDataFrame.UD(wAKDE.nugget)
ud.sf <- st_as_sf(ud.sp)

nugget.sf <- st_as_sf(nugget_df, coords = c("utm_easting","utm_northing")) %>% st_set_crs(32647)

# adke summary data
akde.summary <- summary(wAKDE.nugget)
akde.summary[["CI"]][3]
```
The 95% KDE from before estimated the home range at 9.36 ha which is slightly smaller but very similar to the ctmm 95% home range estimation. Let's see how the ctmm home range fits on Emerald Hill. 

```{r ggplot wADKE, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE, warning=FALSE}
# ggplot for akde
ctmm.akde.1 <- ggplot() + geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_point(data=mcp.points, aes(x=x, y=y), color = "lightgray")  +
  geom_sf(data = ud.sf[3,], fill = "blue", alpha = 0.4)  +
  geom_sf(data = ud.sf[2,], fill = "green", alpha = 0.3) + 
  geom_sf(data = ud.sf[1,], fill = "yellow", alpha = 0.2) +
  labs(x="Longitude", y="Latitude", title = nugget_df$individual.local.identifier) +
  theme_bw() + theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5)) +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 5)
ctmm.akde.1 <- ctmm.akde.1 + annotate("text", x = 467500, y = 4043640, 
                     label = paste("Area ",round(akde.summary[["CI"]][3],2)," sqkm"),
                     fontface = "bold", size = 5, color = "white")

ctmm.akde.2 <- ggplot() + geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data = ud.sf[3,], fill = "blue", alpha = 0.4)  +
  geom_sf(data = ud.sf[2,], fill = "green", alpha = 0.3) + 
  geom_sf(data = ud.sf[1,], fill = "yellow", alpha = 0.2) +
  labs(x="Longitude", y="Latitude", title = nugget_df$individual.local.identifier) +
  theme_bw() + theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5)) +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 5)
ctmm.akde.2 <- ctmm.akde.2 + annotate("text", x = 467500, y = 4043640, 
                     label = paste("Area ",round(akde.summary[["CI"]][3],2)," sqkm"),
                     fontface = "bold", size = 5, color = "white")

ctmm.akde.1 + ctmm.akde.2
```

## Comparison of Methods 

Lastly, let's compare all the home range estimates used in this exercise. 

```{r comparison graphs, include=FALSE}
location.plot <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  theme(panel.grid = element_blank()) +
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_point(data=mcp.points, aes(x=x, y=y), color = "orange2")  +
  labs(x="Easting (m)", y="Northing (m)", title="Occurrence Points") +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 5)
location.plot
mcp.plot.2 <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  theme(panel.grid = element_blank()) +
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data=mcp.sf, alpha = 0.3) +
  labs(x="Easting (m)", y="Northing (m)", title="Minimum Convex Polygon") +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 5)
mcp.plot.2
kde.only.plot.2 <- ggplot() + theme_bw() +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5)) + 
  geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data=kde95.sf, fill = "blue", alpha = 0.4) +
  geom_sf(data=kde75.sf, fill = "green", alpha = 0.3) +
  geom_sf(data=kde50.sf, fill = "yellow", alpha = 0.2)  +
  labs(x="Easting (m)", y="Northing (m)", title="Kernel-Density Estimation") +
  theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 5)
kde.only.plot.2
ctmm.akde.3 <- ggplot() + geom_spatial_rgb(data = emerald.hill, aes(x=x, y=y, r=red, g=green, b=blue)) +
  geom_sf(data = ud.sf[3,], fill = "blue", alpha = 0.4)  +
  geom_sf(data = ud.sf[2,], fill = "green", alpha = 0.3) + 
  geom_sf(data = ud.sf[1,], fill = "yellow", alpha = 0.2) +
  labs(x="Longitude", y="Latitude", title = "Continuous-Time Movement Modeling") +
  theme_bw() + theme(legend.position="none", plot.title = element_text(face = "bold", hjust = 0.5)) +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5), panel.grid = element_blank()) + 
  scale_y_continuous(n.breaks = 5)
ctmm.akde.3
```


```{r comparison, echo=FALSE, fig.align='center', fig.height=8, fig.width=10, message=FALSE, warning=FALSE}
location.plot + mcp.plot.2 + kde.only.plot.2 + ctmm.akde.3
```

